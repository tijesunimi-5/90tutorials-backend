<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Exam Manager Tester</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, textarea, select { margin: 4px; padding: 6px; }
    .exam { border: 1px solid #ccc; padding: 10px; margin-bottom: 12px; }
    .subject { border: 1px dashed #888; margin: 6px; padding: 6px; }
    .question { margin-left: 16px; }
  </style>
</head>
<body>
  <h1>Exam Manager Tester</h1>

  <!-- Create Exam -->
  <h2>Create Exam</h2>
  <form id="createExamForm">
    <input type="text" id="title" placeholder="Exam Title" required>
    <br>
    <textarea id="subjects" rows="4" cols="60"
      placeholder='Subjects JSON (e.g. [{"title":"Math","questions":[{"text":"2+2?","options":["3","4"],"answer":"4","optionType":"checkbox"}]}])'></textarea>
    <br>
    <button type="submit">Create Exam</button>
  </form>
  <button onclick="document.location=`index.html`">test</button>

  <hr>
  <h2>Exams</h2>
  <div id="examList"></div>

  <script>
    const API_BASE = "http://localhost:3000/api/exams"; // change port if needed

    // ===== GET all exams =====
    async function fetchExams() {
      try {
        const res = await fetch(API_BASE);
        if (!res.ok) {
          document.getElementById("examList").textContent = "No exams found.";
          return;
        }
        const exams = await res.json(); // always an array now
        renderExams(exams);
      } catch (err) {
        console.error(err);
        alert("Failed to fetch exams");
      }
    }

    // ===== RENDER exams =====
    function renderExams(exams) {
      const list = document.getElementById("examList");
      list.innerHTML = "";

      exams.forEach(exam => {
        const div = document.createElement("div");
        div.className = "exam";
        div.innerHTML = `
          <h3>${exam.title} (ID: ${exam.id})</h3>
          <button onclick="deleteExam(${exam.id})">Delete Exam</button>
          <h4>Subjects</h4>
        `;

        exam.subjects.forEach(subject => {
          const sDiv = document.createElement("div");
          sDiv.className = "subject";
          sDiv.innerHTML = `
            <strong>${subject.title}</strong> (ID: ${subject.id})
            <button onclick="deleteSubject(${exam.id},${subject.id})">Delete Subject</button>
            <div>
              <input id="qtext-${exam.id}-${subject.id}" placeholder="Question text">
              <input id="qoptions-${exam.id}-${subject.id}" placeholder="Options (comma-separated)">
              <input id="qanswer-${exam.id}-${subject.id}" placeholder="Answer">
              <select id="qtype-${exam.id}-${subject.id}">
                <option value="checkbox">checkbox</option>
                <option value="input">input</option>
              </select>
              <button onclick="addQuestion(${exam.id},${subject.id})">Add Question</button>
            </div>
          `;

          subject.questions.forEach(q => {
            const qDiv = document.createElement("div");
            qDiv.className = "question";
            qDiv.innerHTML = `
              Q${q.id}: ${q.text} [${q.optionType}]
              <button onclick="deleteQuestion(${exam.id},${subject.id},${q.id})">Delete</button>
            `;
            sDiv.appendChild(qDiv);
          });

          div.appendChild(sDiv);
        });

        list.appendChild(div);
      });
    }

    // ===== CREATE exam =====
    document.getElementById("createExamForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      try {
        const title = document.getElementById("title").value;
        const subjects = JSON.parse(document.getElementById("subjects").value || "[]");

        const res = await fetch(API_BASE, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, subjects })
        });
        if (!res.ok) throw new Error("Failed to create exam");
        await fetchExams();
        e.target.reset();
      } catch (err) {
        alert("Error creating exam: " + err.message);
      }
    });

    // ===== DELETE exam =====
    async function deleteExam(id) {
      if (!confirm("Delete this exam?")) return;
      await fetch(`${API_BASE}/${id}`, { method: "DELETE" });
      fetchExams();
    }

    // ===== DELETE subject =====
    async function deleteSubject(examId, subjectId) {
      if (!confirm("Delete this subject?")) return;
      await fetch(`${API_BASE}/${examId}/subjects/${subjectId}`, { method: "DELETE" });
      fetchExams();
    }

    // ===== ADD question =====
    async function addQuestion(examId, subjectId) {
      const qtext = document.getElementById(`qtext-${examId}-${subjectId}`).value;
      const qoptions = document.getElementById(`qoptions-${examId}-${subjectId}`).value.split(",");
      const qanswer = document.getElementById(`qanswer-${examId}-${subjectId}`).value;
      const qtype = document.getElementById(`qtype-${examId}-${subjectId}`).value;

      const res = await fetch(`${API_BASE}/${examId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          subjects: [
            {
              id: subjectId,
              questions: [{ text: qtext, options: qoptions, answer: qanswer, optionType: qtype }]
            }
          ]
        })
      });

      if (!res.ok) {
        const msg = await res.text();
        alert("Error adding question: " + msg);
      }
      fetchExams();
    }

    // ===== DELETE question =====
    async function deleteQuestion(examId, subjectId, qId) {
      if (!confirm("Delete this question?")) return;
      await fetch(`${API_BASE}/${examId}/subjects/${subjectId}/questions/${qId}`, { method: "DELETE" });
      fetchExams();
    }

    // Initial load
    fetchExams();
  </script>
</body>
</html>
